Bootstrap: debootstrap                                                          
MirrorURL: http://deb.debian.org/debian                                         
OSVersion: stable

%files

    # libraries source
    requirements.txt /opt/cells/
    Makefile /opt/cells/
    *.*pp /opt/cells/

    # python scripts
    *.py /opt/cells/

%post -c /bin/bash

    cd /opt/cells/

    # install python
    apt install -y python3 python3-pip
    ln -sf $(which python3) ${PATH%%:*}/python

    # install python requirements
    python -m pip install -r requirements.txt --break-system-packages

    # compile
    make bind.so

    # python path
    echo "export PYTHONPATH=\${PYTHONPATH}:$(realpath $(pwd)/..)" >> $SINGULARITY_ENVIRONMENT

    # matplotlib display support
    # https://pawseysc.github.io/singularity-containers/42-x11-gnuplot/index.html
    apt install -y xauth python3-pyqt5
    echo "export MPLBACKEND=Qt5Agg" >> $SINGULARITY_ENVIRONMENT

%runscript

    exec $@

